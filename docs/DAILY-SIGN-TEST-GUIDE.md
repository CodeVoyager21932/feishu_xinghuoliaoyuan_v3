# 日签功能测试指南

## 快速测试步骤

### 1. 前置准备
- ✅ 确保已安装微信开发者工具
- ✅ 确保项目已配置云开发环境
- ✅ 确保 `miniprogram/data/daily-quotes.js` 文件存在

### 2. 本地测试（无需云开发）

#### 步骤 1: 打开项目
在微信开发者工具中打开项目。

#### 步骤 2: 编译运行
点击"编译"按钮，查看首页。

#### 步骤 3: 测试日签入口
1. 在首页右上角找到"📅 日签"按钮
2. 点击按钮，应该弹出全屏模态框
3. 检查是否显示今日名言内容

#### 步骤 4: 测试海报生成
1. 在弹窗中点击"保存到相册"按钮
2. 等待海报生成（会显示"生成中..."提示）
3. 检查 Canvas 是否正确绘制

#### 步骤 5: 测试保存功能
1. 首次保存会请求相册授权
2. 点击"允许"授权
3. 保存成功后会显示"已保存到相册"提示
4. 打开手机相册，查看保存的图片

### 3. 云开发测试

#### 步骤 1: 初始化云数据库
参考 `cloud/database/daily_quotes_init.md` 创建集合。

#### 步骤 2: 部署云函数
```bash
# 在微信开发者工具中
# 右键 cloud/functions/get-daily-quote
# 选择"上传并部署：云端安装依赖"
```

#### 步骤 3: 测试云函数
在云开发控制台测试云函数：
```json
// 输入参数（空对象）
{}

// 预期输出
{
  "success": true,
  "data": {
    "date": "2025-11-20",
    "image_url": "/images/daily-sign-bg/bg-001.jpg",
    "quote_content": "为有牺牲多壮志，敢教日月换新天。",
    "author": "毛泽东《七律·到韶山》",
    "lucky_tips": "学习党史，传承红色基因"
  }
}
```

#### 步骤 4: 修改首页加载逻辑
如果需要从云端加载数据，修改 `miniprogram/pages/index/index.js`:

```javascript
// 加载今日名言（从云端）
loadTodayQuote() {
  wx.cloud.callFunction({
    name: 'get-daily-quote',
    success: (res) => {
      if (res.result.success) {
        this.setData({ todayQuote: res.result.data });
      }
    },
    fail: (err) => {
      console.error('获取名言失败，使用本地数据', err);
      // 降级到本地数据
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
      const todayQuote = dailyQuotesData[dayOfYear % dailyQuotesData.length];
      this.setData({ todayQuote });
    }
  });
},
```

## 测试检查清单

### UI 测试
- [ ] 日签按钮在首页右上角正确显示
- [ ] 点击按钮后弹窗正常打开
- [ ] 弹窗背景遮罩正确显示
- [ ] 关闭按钮可以正常关闭弹窗
- [ ] 点击遮罩层可以关闭弹窗
- [ ] 今日宜忌文字正确显示
- [ ] 两个操作按钮正确显示

### Canvas 绘制测试
- [ ] 背景图片正确加载
- [ ] 半透明蒙层正确显示
- [ ] 日期印章（红色圆形）正确绘制
- [ ] 竖排诗词正确显示（从右到左）
- [ ] 作者署名正确显示
- [ ] 用户昵称正确显示
- [ ] 用户头像正确显示（圆形）
- [ ] 整体布局美观，无错位

### 功能测试
- [ ] 点击"保存到相册"能正常保存
- [ ] 首次保存会请求相册授权
- [ ] 拒绝授权后会显示引导弹窗
- [ ] 保存成功后显示成功提示
- [ ] 保存后会更新打卡记录
- [ ] 点击"分享给好友"显示提示
- [ ] 生成过程中按钮显示禁用状态
- [ ] 重复点击不会重复生成

### 数据测试
- [ ] 每天显示不同的名言
- [ ] 本地数据正确加载
- [ ] 云端数据正确加载（如果配置）
- [ ] 数据加载失败时有降级方案
- [ ] 打卡记录正确保存到本地
- [ ] 连续打卡天数正确计算

### 性能测试
- [ ] 海报生成时间 < 3秒
- [ ] 弹窗打开动画流畅
- [ ] 关闭弹窗无卡顿
- [ ] 多次生成不会内存泄漏
- [ ] 图片加载不会阻塞UI

### 兼容性测试
- [ ] iOS 系统正常运行
- [ ] Android 系统正常运行
- [ ] 不同屏幕尺寸正常显示
- [ ] 不同设备像素比正常显示
- [ ] 低版本基础库兼容（如果需要）

## 常见问题排查

### 问题 1: 点击日签按钮没反应
**排查步骤**:
1. 检查 `index.json` 是否正确引入组件
2. 检查 `index.js` 中是否有 `onOpenDailySign` 方法
3. 检查控制台是否有报错

### 问题 2: 弹窗显示空白
**排查步骤**:
1. 检查 `todayQuote` 数据是否正确加载
2. 检查 `daily-quotes.js` 文件是否存在
3. 检查组件的 `visible` 属性是否为 `true`

### 问题 3: Canvas 不显示内容
**排查步骤**:
1. 检查 Canvas 节点是否正确获取
2. 检查图片路径是否正确
3. 检查 Canvas 尺寸是否设置
4. 查看控制台是否有绘制错误

### 问题 4: 保存图片失败
**排查步骤**:
1. 检查是否已授权相册权限
2. 检查海报是否已生成（posterPath 不为空）
3. 检查临时文件路径是否有效
4. 查看控制台错误信息

### 问题 5: 图片模糊
**解决方案**:
- 确保 Canvas 尺寸乘以了设备像素比（DPR）
- 检查 `ctx.scale(dpr, dpr)` 是否正确调用

### 问题 6: 竖排文字显示异常
**解决方案**:
- 确保使用了支持中文的字体
- 检查文字绘制的 x, y 坐标计算
- 确保使用 `[...text]` 正确分割字符

## 调试技巧

### 1. 查看 Canvas 内容
在 `drawPoster` 方法中添加日志：
```javascript
console.log('Canvas 尺寸:', canvas.width, canvas.height);
console.log('绘制完成');
```

### 2. 导出临时图片查看
```javascript
wx.canvasToTempFilePath({
  canvas: canvas,
  success: (res) => {
    console.log('临时图片路径:', res.tempFilePath);
    // 可以在控制台复制路径，在浏览器中查看
  }
});
```

### 3. 模拟不同日期
修改 `loadTodayQuote` 方法：
```javascript
// 测试特定日期
const testDate = new Date('2025-11-25');
const dayOfYear = Math.floor((testDate - new Date(testDate.getFullYear(), 0, 0)) / 86400000);
```

## 真机测试注意事项

1. **相册权限**: 真机上首次保存需要用户授权
2. **网络环境**: 云函数调用需要网络连接
3. **图片加载**: 确保图片路径在真机上可访问
4. **性能差异**: 真机性能可能低于模拟器，注意优化

## 测试报告模板

```markdown
## 日签功能测试报告

**测试时间**: 2025-11-20
**测试人员**: [姓名]
**测试环境**: 
- 开发工具版本: 1.06.x
- 基础库版本: 3.x.x
- 测试设备: iPhone 13 / 小米 12

### 测试结果
- [ ] UI 显示正常
- [ ] 功能运行正常
- [ ] 性能表现良好
- [ ] 无明显 Bug

### 发现的问题
1. [问题描述]
2. [问题描述]

### 改进建议
1. [建议内容]
2. [建议内容]
```

---

**测试完成后，请将结果反馈给开发团队！**
