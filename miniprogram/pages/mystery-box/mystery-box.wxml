<!--pages/mystery-box/mystery-box.wxml-->
<navigation-bar title="机密档案" showBack="{{true}}" showHome="{{true}}" background="transparent"></navigation-bar>
<view class="mystery-box-page">
  <!-- 顶部积分 -->
  <view class="points-header">
    <view class="points-card">
      <text class="points-label">学习积分</text>
      <text class="points-value">{{userPoints}}</text>
    </view>
    <text class="cost-tip">每次开启消耗 100 积分</text>
  </view>

  <!-- 补给箱 -->
  <view class="box-container">
    <view class="box-wrapper {{isDrawing ? 'shaking' : ''}}" bindtap="onDrawRelic" hover-class="btn-hover">
      <view class="box-icon">📦</view>
      <view class="box-hint-container">
        <text class="box-hint" wx:if="{{!isDrawing}}">点击开启机密档案</text>
        <view class="typing-indicator" wx:else>
          <text>解</text><text>密</text><text>中</text>
          <view class="dots">
            <view class="dot"></view><view class="dot"></view><view class="dot"></view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- Confetti Canvas -->
  <canvas type="2d" id="confetti" class="confetti-canvas" style="pointer-events: none;"></canvas>

  <!-- 稀有度说明 -->
  <view class="rarity-info">
    <text class="info-title">信物稀有度</text>
    <view class="rarity-list">
      <view class="rarity-item">
        <view class="rarity-badge ssr">传说</view>
        <text class="rarity-prob">5%</text>
      </view>
      <view class="rarity-item">
        <view class="rarity-badge sr">稀有</view>
        <text class="rarity-prob">25%</text>
      </view>
      <view class="rarity-item">
        <view class="rarity-badge r">普通</view>
        <text class="rarity-prob">70%</text>
      </view>
    </view>
  </view>

  <!-- 底部按钮 -->
  <view class="bottom-actions">
    <button class="btn-secondary" bindtap="goToMuseum">
      🏛️ 我的珍藏馆
    </button>
  </view>
</view>

<!-- 结果弹窗 -->
<view class="result-modal" wx:if="{{showResult}}">
  <view class="result-mask" bindtap="closeResult"></view>
  <view class="result-content">
    <text class="result-title">{{resultIsNew ? '发现历史见证物！' : '重复信物'}}</text>
    <view class="result-rarity {{resultRelic.rarity}}">{{resultRelic.rarityName}}</view>
    <text class="result-name">{{resultRelic.name}}</text>
    <text class="result-story">{{resultRelic.story}}</text>
    <view class="result-actions">
      <button class="btn-primary" bindtap="closeResult">确定</button>
    </view>
  </view>
</view>
