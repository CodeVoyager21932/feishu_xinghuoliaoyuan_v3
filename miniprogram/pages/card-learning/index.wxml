<!-- å¡ç‰‡å­¦ä¹ é¡µé¢ -->
<wxs module="touch" src="./touch.wxs"></wxs>
<view class="card-learning-page">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration"></view>

  <!-- é¡¶éƒ¨è¿›åº¦ (Glassmorphism) -->
  <view class="progress-bar-glass animate-fade-in">
    <view class="progress-info">
      <view class="progress-label">
        <text class="icon-fire">ğŸ”¥</text>
        <text class="progress-text">ä»Šæ—¥æŒ‘æˆ˜</text>
      </view>
      <text class="progress-percent">{{todayCount}}/{{totalCount}}</text>
    </view>
    <view class="progress-track">
      <view class="progress-fill" style="width: {{progressPercent}}%"></view>
    </view>
  </view>

  <!-- å¡ç‰‡å®¹å™¨ -->
  <view class="card-container">
    <view class="card-stack">
      <!-- å½“å‰å¡ç‰‡ -->
      <view 
        class="card {{flipped ? 'flipped' : ''}}"
        style="transform: {{cardTransform}}; transition: {{cardTransition}};"
        wx:if="{{currentCard}}"
        data-card-id="{{currentCard.id}}"
        bindtouchstart="{{touch.touchStart}}"
        bindtouchmove="{{touch.touchMove}}"
        bindtouchend="{{touch.touchEnd}}"
        bindtap="onCardTap"
      >
        <!-- æ­£é¢ -->
        <view class="card-front">
          <image class="card-image" src="{{currentCard.front_image}}" mode="aspectFill" />
          <view class="card-overlay"></view>
          <view class="card-content-front">
            <view class="card-badge">{{currentCard.category}}</view>
            <view class="card-title-wrapper">
              <text class="card-title font-serif">{{currentCard.front_title}}</text>
              <text class="tap-hint">ç‚¹å‡»ç¿»è½¬</text>
            </view>
          </view>
        </view>

        <!-- èƒŒé¢ -->
        <view class="card-back">
          <view class="card-header-back">
            <text class="card-title-small font-serif">{{currentCard.front_title}}</text>
            <view class="ai-btn" catchtap="askAI">
              <text class="icon-ai">ğŸ¤–</text>
              <text>AIè¯¦è§£</text>
            </view>
          </view>
          
          <scroll-view scroll-y class="card-scroll-content" catchtap="stopPropagation">
            <text class="content-text">{{currentCard.back_content}}</text>
            <view class="card-keywords">
              <view class="keyword" wx:for="{{currentCard.back_keywords}}" wx:key="index">
                <text># {{item}}</text>
              </view>
            </view>
          </scroll-view>
        </view>

        <!-- æ»‘åŠ¨æç¤º (Overlay) -->
        <view class="swipe-overlay left {{swipeDirection === 'left' ? 'show' : ''}}">
          <view class="swipe-icon-wrapper review">
            <text class="swipe-icon">â†º</text>
            <text class="swipe-text">å¾…å¤ä¹ </text>
          </view>
        </view>
        <view class="swipe-overlay right {{swipeDirection === 'right' ? 'show' : ''}}">
          <view class="swipe-icon-wrapper master">
            <text class="swipe-icon">âœ“</text>
            <text class="swipe-text">å·²æŒæ¡</text>
          </view>
        </view>
      </view>

      <!-- ä¸‹ä¸€å¼ å¡ç‰‡é¢„è§ˆ -->
      <view class="card next-card" wx:if="{{nextCard}}">
        <view class="card-front">
          <image class="card-image" src="{{nextCard.front_image}}" mode="aspectFill" />
          <view class="card-overlay"></view>
          <view class="card-content-front">
            <view class="card-title-wrapper">
              <text class="card-title font-serif">{{nextCard.front_title}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state animate-fade-in" wx:if="{{!currentCard && !isLoading}}">
      <view class="empty-content">
        <text class="empty-emoji">ğŸ‰</text>
        <text class="empty-title font-serif">ä»Šæ—¥ä»»åŠ¡å®Œæˆï¼</text>
        <text class="empty-desc">æ˜Ÿç«ç‡åŸï¼Œç§¯å°‘æˆå¤š</text>
        <button class="review-btn" bindtap="startReview">
          <text>å†æ¥ä¸€ç»„</text>
        </button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® (Floating) -->
  <view class="action-bar animate-slide-up" wx:if="{{currentCard}}">
    <view class="action-btn review" bindtap="markAsReview">
      <text class="icon-action">â†º</text>
    </view>
    <view class="action-btn flip" bindtap="toggleFlip">
      <text class="icon-action">â‡„</text>
    </view>
    <view class="action-btn master" bindtap="markAsMastered">
      <text class="icon-action">âœ“</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡é¢æ¿ (Mini Dashboard) -->
  <view class="stats-mini animate-fade-in">
    <view class="stat-pill">
      <text class="stat-label">å·²æŒæ¡</text>
      <text class="stat-num master-color">{{stats.mastered}}</text>
    </view>
    <view class="stat-pill">
      <text class="stat-label">å¾…å¤ä¹ </text>
      <text class="stat-num review-color">{{stats.reviewing}}</text>
    </view>
  </view>
</view>
